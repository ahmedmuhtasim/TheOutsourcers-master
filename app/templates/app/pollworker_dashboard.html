<html>
	<head>
		<title>VA - PW Dashboard</title>
		<script
			src="https://code.jquery.com/jquery-3.3.1.min.js"
			integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
			crossorigin="anonymous"></script>
		{% load static %}
		<link rel="stylesheet" href="{% static 'css/global.css' %}">
		<link rel="stylesheet" href="{% static 'css/pollworkerDashboard.css' %}">
	</head>
	<body>
		{% if logged_on %}
			{% include './components/loggedInHeader.html' %}
		{% else %}
			{% include './components/header.html' %}
		{% endif %}
		
		<div class="body">
			<div class="body-title">
				<p>Pollworker Dashboard <span class="text-24 red-text">{{errorMessage}}</span></p>
			</div>
			<div class="body-contents">
				<div class="search form" id="search">
					<div>
						<input placeholder="First Name"
							id="firstName"
							value="John"
							required>

					</div>
					<div>
						<input placeholder="Last Name"
							id="lastName"
							value="Newsom"
							required>
					</div>
					<div>
						<input placeholder="Voter Number"
							id="voterNumber"
							value="2"
							required>
					</div>
					<div>
						<input type="submit" 
							id="searchVoter" 
							value="Search">
					</div>
				</div>
				<div class="results" id="results">

				</div>
			</div>
		</div>

		{% include './components/footer.html' %}
	</body>
	<script>
		$('#searchVoter').click(function() {
			
			const firstName = $('#firstName').val();
			const lastName = $('#lastName').val();
			const voterNumber = $('#voterNumber').val();

			if (!firstName || !lastName || !voterNumber) {
				return false;
			} else {
				const url = `http://localhost:8000/api/searchVoters/?
					firstName=${firstName}&
					lastName=${lastName}&
					voterNumber=${voterNumber}&`;
				fetch(url, {
					cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
					credentials: 'same-origin', // include, same-origin, *omit
					headers: {
						'content-type': 'application/json'
					},
					method: 'GET', // *GET, POST, PUT, DELETE, etc.
					mode: 'cors', // no-cors, cors, *same-origin
					redirect: 'follow', // manual, *follow, error
					referrer: 'no-referrer', // *client, no-referrer
				}).then((response) => {
					return response.json();
				}).then((data) => {
					$('#results').empty();
					const voters = data.voters;
					voters.forEach((voter) => {
						let markup = `
							<div>
								<h1>${voter.first_name + ' ' + voter.last_name }</h1>
								<h3>First 4 Digits of VN: ${voter.voter_number.substring(0, 4)}</h3>
								<div class="form gen-serial-code" voter_number=${voter.voter_number} election_id="${'2012-09'}">
									<input type="hidden" name="voter_number" value="${voter.voter_number}">
									<input type="hidden" name="election_id" value="${'2012-09'}">
									<input type="Submit" value="Get Serial Code">
								</div>
								<hr>
							</div>
						`;
						$('#results').append(markup);
					});
				});
			}
		})

		$(document).on('click', '.gen-serial-code', function() {
			const voter_number = $(this).attr('voter_number');
			const election_id = $(this).attr('election_id');
			const _this = this;
			const url = `http://theoutsourcers.herokuapp.com/getVoterSerialCode/?
				voter_number=${voter_number}&
				election_id=${election_id}&`;
			
			fetch(url, {
				cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
				credentials: 'same-origin', // include, same-origin, *omit
				headers: {
					'content-type': 'application/json'
				},
				method: 'GET', // *GET, POST, PUT, DELETE, etc.
				mode: 'cors', // no-cors, cors, *same-origin
				redirect: 'follow', // manual, *follow, error
				referrer: 'no-referrer', // *client, no-referrer
			}).then((response) => {
				return response.json();
			}).then((data) => {
				console.log({
					data: data
				});

				if (data.message === "Voter has already voted in this election") {
					$(_this).append('<p class="red-text text-18">User has already voted in this election.</p>')
				} else if (data.status === "200 - OK") {
					$(_this).append(`<p class="blue-text text-18">Serial Code: ${data.serial_code}</p>`)
				}

			});
		})
	</script>
</html>